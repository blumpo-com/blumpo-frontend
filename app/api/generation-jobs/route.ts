import { NextResponse } from 'next/server';
import { getUser } from '@/lib/db/queries';
import { getGenerationJobsForUser } from '@/lib/db/queries/generation';
import { getAdArchetypeByCode } from '@/lib/db/queries/ads';

// Get last 10 generation jobs for authenticated user
export async function GET(req: Request) {
  try {
    const user = await getUser();
    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const jobsResult = await getGenerationJobsForUser(user.id, 10);
    
    // Transform jobs to include display names
    const jobsWithDisplayNames = await Promise.all(
      jobsResult.map(async ({ job, adImageCount }) => {
        let displayName = 'Generation job';
        
        if (job.autoGenerated) {
          displayName = 'Quick ads';
        } else if (job.archetypeCode) {
          const archetype = await getAdArchetypeByCode(job.archetypeCode);
          if (archetype) {
            displayName = archetype.displayName;
          }
        }
        
        // Check if job is "new" (SUCCEEDED with completedAt but not viewed)
        const isNew = 
          job.status === 'SUCCEEDED' &&
          (job.viewedAt === null || (job.viewedAt && job.completedAt && new Date(job.viewedAt) < new Date(job.completedAt))) &&
          // Exclude jobs with website_url in params (new user generation jobs)
          !(job.params && typeof job.params === 'object' && 'website_url' in job.params);
        
        return {
          id: job.id,
          status: job.status,
          displayName,
          createdAt: job.createdAt,
          completedAt: job.completedAt,
          viewedAt: job.viewedAt,
          archetypeCode: job.archetypeCode,
          autoGenerated: job.autoGenerated,
          isNew,
          adImageCount,
        };
      })
    );

    return NextResponse.json(jobsWithDisplayNames);
  } catch (error) {
    console.error('Error fetching generation jobs:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
