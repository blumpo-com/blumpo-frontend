# Quick Ads Generation Refactoring Summary

## Overview
Refactored the quick ads generation feature to use a dedicated API route (`/api/generate/quick-ads`) similar to the customized ads flow, with proper token reservation system.

---

## Key Changes

### 1. New API Routes

#### `/api/generate/quick-ads/route.ts` (NEW)
- Dedicated endpoint for quick ads generation
- Mirrors the customized-ads flow
- Uses `reserveTokens()` to deduct tokens when generation starts
- Webhook: `https://automationforms.app.n8n.cloud/webhook/quick-ads`
- Waits for callback from n8n (event-driven, no polling)
- Refunds tokens on failure

#### `/api/quick-ads/create/route.ts` (NEW)
- Creates QUEUED generation jobs
- No tokens deducted at this stage
- Sets `autoGenerated: true` flag
- Returns job ID for navigation

### 2. Updated API Routes

#### `/api/generate/route.ts`
- **Removed**: All quick ads logic (`brandId`, `autoGenerated` parameters)
- **Restored**: Original free flow generation only
- Now only handles website URL-based generation

#### `/api/quick-ads/mark-displayed/route.ts`
- **Removed**: Token deduction logic (tokens now taken at generation start)
- **Kept**: Ad marking and cleanup logic
- Still marks ads as `ready_to_display: true`
- Still deletes unused format ads from Vercel Blob

### 3. Database Query Updates

#### `lib/db/queries/generation.ts`
- **Removed**: Conditional token deduction for `autoGenerated` jobs
- **Restored**: Always deduct tokens in `createGenerationJob()`
- Token reservation now happens via `/api/generate/quick-ads`

#### `lib/db/queries/quick-ads.ts` (NEW)
- New helper function: `createQuickAdsJob()`
- Creates QUEUED jobs with `autoGenerated: true`
- Sets formats to `['1:1', '16:9']`
- No token deduction at creation

### 4. Frontend Updates

#### `app/(dashboard)/dashboard/quick-ads-generation/page.tsx`
- **Updated**: Uses `/api/quick-ads/create` instead of `/api/generate`
- Creates QUEUED job first
- Navigates to ad generation page with `job_id` and `quick_ads=true`

#### `app/(dashboard)/dashboard/ad-generation/page.tsx`
- **Updated**: Detects job type (`autoGenerated` flag)
- Routes to `/api/generate/quick-ads` for quick ads
- Routes to `/api/generate/customized-ads` for customized ads
- No more quick ads-specific polling logic

#### `app/(dashboard)/dashboard/page.tsx`
- **Updated**: Uses `/api/quick-ads/create` + `/api/generate/quick-ads`
- Triggers background generation for paid users
- Generates both formats in one job

---

## Token Deduction Flow

### Old Flow (REMOVED)
```
User clicks "Next" 
  → POST /api/generate { brandId, autoGenerated: true }
  → Job created with tokensCost = 0
  → Tokens NOT deducted
  → User sees ads
  → POST /api/quick-ads/mark-displayed
  → Tokens deducted (50)
```

### New Flow (CURRENT)
```
User clicks "Next"
  → POST /api/quick-ads/create { brandId }
  → QUEUED job created (no tokens)
  → Navigate to /dashboard/ad-generation
  → POST /api/generate/quick-ads { jobId }
  → Tokens RESERVED (50) via reserveTokens()
  → Job status: QUEUED → RUNNING
  → n8n generates ads
  → Callback received
  → Job status: SUCCEEDED
  → User sees ads
  → POST /api/quick-ads/mark-displayed
  → No token deduction (already paid)
```

---

## Benefits

1. **Consistency**: Quick ads now use the same flow as customized ads
2. **Token Safety**: Tokens reserved upfront, refunded on failure
3. **Separation of Concerns**: `/api/generate` for free flow, `/api/generate/quick-ads` for quick ads
4. **Proper Webhooks**: Dedicated webhook for quick ads
5. **Better Error Handling**: Same error handling as customized ads
6. **Event-Driven**: No polling, callback-based generation

---

## Migration Notes

- No database schema changes required
- All existing jobs continue to work
- Token ledger entries use `JOB_RESERVE` reason
- `autoGenerated` flag still used for identification
- `ready_to_display` flag still used for filtering

---

## Testing Checklist

- [ ] Create new quick ads job
- [ ] Generate quick ads (both formats)
- [ ] Display quick ads (mark as ready)
- [ ] Cleanup unused format
- [ ] Token deduction verification
- [ ] Token refund on failure
- [ ] Paid user maintenance
- [ ] Check existing ads flow
- [ ] Insufficient tokens error
- [ ] Generation timeout handling
