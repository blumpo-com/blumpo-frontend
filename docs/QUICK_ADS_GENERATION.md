# Quick Ads Generation Feature

This document describes how the **Quick Ads Generation** feature works in the Blumpo platform. Quick ads are pre-generated ad images that can be instantly displayed to users, eliminating wait times for ad creation.

---

## Overview

Quick Ads Generation is an automatic ad creation system that:

- **Pre-generates** ad images in batches (5 ads per format)
- **Generates** both `1:1` (square) and `16:9` (story) formats simultaneously
- **Maintains** a pool of ready-to-use ads for instant access
- **Takes tokens** upfront when ads are generated, not when displayed
- **Automatically cleans up** unused format ads when a format is selected

---

## What Ads Are Generated

### Generation Details

When quick ads are generated:

1. **Format Coverage**: Both formats are always generated:
   - `1:1` (square format) - 5 ads
   - `16:9` (story format) - 5 ads
   - **Total: 10 ad images per generation job**

2. **Generation Method**: Ads are generated using:
   - Brand's product photos and assets
   - Automatic archetype selection (handled by n8n workflow)
   - Automatic insight selection from brand insights
   - Default generation parameters

3. **Storage Status**: Generated ads have:
   - `ready_to_display: false` initially (reserved for quick ads)
   - `auto_generated: true` flag on the generation job
   - Stored in Vercel Blob storage
   - Linked to user's brand (if brand selected)

### Paid User Maintenance

For **paid users** (non-FREE subscription plans):

- System maintains **20 ads minimum**:
  - **10 ads** in `1:1` format
  - **10 ads** in `16:9` format
- Maintenance happens automatically when:
  - User visits the dashboard
  - Count falls below threshold (10 per format)
  - User has an active brand selected
- Maintenance generates new ads **before** they're needed

---

## API Endpoints and Files

### Frontend Components

#### Page Component
- **File**: `app/(dashboard)/dashboard/quick-ads-generation/page.tsx`
- **Purpose**: Main UI for quick ads generation
- **Features**:
  - Format selection (1:1, 16:9, or both)
  - Checks for existing ads before generating
  - Navigates to ad generation page on completion

#### Ad Generation Page
- **File**: `app/(dashboard)/dashboard/ad-generation/page.tsx`
- **Purpose**: Displays generated ads or generation progress
- **Quick Ads Flow**:
  - Polls job status for quick ads generation
  - Marks ads as displayed when job completes
  - Shows `CreatingProcess` component during generation

#### Dashboard Page
- **File**: `app/(dashboard)/dashboard/page.tsx`
- **Purpose**: Entry point for paid user maintenance
- **Functionality**:
  - Checks paid user ad counts on page load
  - Triggers background generation if counts are low

### API Routes

#### 1. Check for Existing Quick Ads
- **Endpoint**: `GET /api/quick-ads`
- **File**: `app/api/quick-ads/route.ts`
- **Parameters**:
  - `format` (required): `'1:1'` or `'16:9'`
  - `brandId` (optional): Specific brand ID
- **Returns**:
  ```json
  {
    "hasAds": true,
    "ads": [...],
    "jobIds": [...]
  }
  ```
- **Purpose**: Checks if user has 5+ ready ads for selected format

#### 2. Generate Quick Ads
- **Endpoint**: `POST /api/generate`
- **File**: `app/api/generate/route.ts`
- **Request Body**:
  ```json
  {
    "brandId": "uuid",
    "autoGenerated": true
  }
  ```
- **Response**:
  ```json
  {
    "job_id": "uuid",
    "status": "QUEUED"
  }
  ```
- **Purpose**: Creates generation job for quick ads (10 ads total)

#### 3. Mark Ads as Displayed
- **Endpoint**: `POST /api/quick-ads/mark-displayed`
- **File**: `app/api/quick-ads/mark-displayed/route.ts`
- **Request Body**:
  ```json
  {
    "jobId": "uuid",
    "format": "1:1" // or "16:9"
  }
  ```
- **Purpose**:
  - Marks selected format ads as `ready_to_display: true`
  - Deletes unused format ads from Vercel Blob
  - Marks unused ads as deleted in database

#### 4. Check Paid User Status
- **Endpoint**: `GET /api/quick-ads/check-paid-user`
- **File**: `app/api/quick-ads/check-paid-user/route.ts`
- **Parameters**:
  - `brandId` (optional): Specific brand ID
- **Returns**:
  ```json
  {
    "isPaid": true,
    "needsGeneration": true,
    "format1x1Count": 5,
    "format16x9Count": 8,
    "needs1x1": true,
    "needs16x9": false
  }
  ```
- **Purpose**: Checks if paid user needs ad generation (maintenance)

### Database Queries

#### Query Functions
- **File**: `lib/db/queries/ads.ts`

**Functions**:
- `getQuickAdsForFormat(userId, brandId, format, limit)` - Retrieves available quick ads
- `markAdsAsReadyToDisplay(adImageIds)` - Marks ads as displayed
- `getQuickAdsCountByFormat(userId, brandId, format)` - Counts available ads
- `getUnusedFormatAds(jobId, selectedFormat)` - Gets ads to delete

#### Generation Queries
- **File**: `lib/db/queries/generation.ts`
- **Function**: `createGenerationJob()` - Creates job with `autoGenerated` flag

### Database Schema

#### New Columns

**`generation_job` table**:
- `auto_generated` (boolean, default: false) - Marks automatically generated jobs

**`ad_image` table**:
- `ready_to_display` (boolean, default: false) - Marks ads reserved for quick ads

---

## When Tokens Are Taken

### Token Deduction

Tokens are **deducted immediately** when the generation job is created, not when ads are displayed.

1. **Generation Time**:
   - **Amount**: 50 tokens per generation job
   - **When**: Job creation (before n8n workflow starts)
   - **Method**: Atomic transaction in `createGenerationJob()`
   - **Ledger Entry**: Recorded with reason `'GENERATION'` and job ID

2. **Token Refund** (if generation fails):
   - If job creation fails before n8n trigger: Full refund (50 tokens)
   - If n8n workflow fails: Full refund (50 tokens)
   - If insufficient tokens: Error returned, no deduction

### Token Cost Summary

| Event | Token Cost | When |
|-------|-----------|------|
| Generate 10 quick ads (both formats) | 50 tokens | Job creation |
| Display existing ads | 0 tokens | Free (already paid) |
| Maintenance generation (paid users) | 50 tokens per format | Background job creation |

**Note**: One generation job (50 tokens) produces **10 ads total** (5 per format).

---

## User Availability

### Feature Availability

1. **All Users** (including FREE tier):
   - Can access quick ads generation page
   - Can generate quick ads on-demand
   - Must have sufficient tokens (50 tokens)
   - Must have an active brand

2. **Paid Users** (non-FREE subscriptions):
   - All above features
   - **Automatic maintenance** of 20 ads (10 per format)
   - Background generation when counts are low
   - Faster access to ready ads

### Requirements

**Minimum Requirements**:
- Authenticated user account
- Active brand with product photos
- Sufficient token balance (50 tokens minimum)

**Brand Requirements**:
- Brand must be created and linked to user
- Brand should have product photos extracted
- Brand insights should be available (for better ad quality)

---

## What Happens After Generation

### Generation Flow

1. **Job Creation**:
   - Generation job created with `autoGenerated: true`
   - Job status: `QUEUED`
   - n8n workflow triggered with job ID and brand ID
   - User navigated to ad generation page

2. **Generation Process**:
   - n8n workflow processes job
   - Generates 10 ads (5 per format) in parallel
   - Ads saved to database with `ready_to_display: false`
   - Job status: `RUNNING` → `SUCCEEDED`

3. **User Experience**:
   - User sees `CreatingProcess` component
   - Page polls job status every few seconds
   - When complete, automatically transitions to ad review

### Display Flow

When user selects a format:

1. **Format Selection**:
   - User selects format (1:1 or 16:9)
   - System retrieves 5 ads for that format

2. **Marking as Displayed**:
   - Selected format ads marked: `ready_to_display: true`
   - These ads now appear in normal ad listings
   - Unused format ads deleted from storage

3. **Cleanup**:
   - Unused format ads deleted from Vercel Blob
   - Unused ads marked as `is_deleted: true` in database
   - Only selected format ads remain accessible

### Using Existing Ads

If 5+ ads already exist for selected format:

1. **Instant Display**:
   - Ads retrieved immediately (no generation wait)
   - User navigated directly to ad review page
   - Selected format ads marked as displayed
   - Unused format ads cleaned up

2. **No Token Cost**:
   - Tokens already deducted during generation
   - Displaying existing ads is free

### Paid User Maintenance

After maintenance check triggers generation:

1. **Background Generation**:
   - Generation jobs created automatically
   - No user interaction required
   - Ads generated in background

2. **Ready for Use**:
   - Generated ads available for next quick ads request
   - User gets instant access to ads
   - No wait time for ad creation

---

## Technical Flow Diagram

```
User selects format
    ↓
Check /api/quick-ads?format=1:1
    ↓
Has 5+ ads? → Yes → Display ads → Mark as displayed → Cleanup unused
    ↓ No
POST /api/generate { brandId, autoGenerated: true }
    ↓
50 tokens deducted
    ↓
Generation job created (status: QUEUED)
    ↓
n8n workflow triggered
    ↓
10 ads generated (5 per format)
    ↓
Ads saved (ready_to_display: false)
    ↓
Job status: SUCCEEDED
    ↓
User selects format
    ↓
Mark selected format as displayed
    ↓
Delete unused format from storage
```

---

## Key Database Operations

### Quick Ads Retrieval

```sql
SELECT ad_image.*, generation_job.*
FROM ad_image
INNER JOIN generation_job ON ad_image.job_id = generation_job.id
WHERE ad_image.user_id = ?
  AND ad_image.brand_id = ? (optional)
  AND ad_image.format = ? ('1:1' or '16:9')
  AND ad_image.ready_to_display = false
  AND ad_image.is_deleted = false
  AND generation_job.auto_generated = true
  AND generation_job.status = 'SUCCEEDED'
ORDER BY ad_image.created_at DESC
LIMIT 5;
```

### Mark as Displayed

```sql
UPDATE ad_image
SET ready_to_display = true
WHERE id IN (...selected ad IDs...);
```

### Cleanup Unused Format

```sql
-- 1. Delete from Vercel Blob (via API)
DELETE FROM blob storage WHERE path IN (...unused ad paths...);

-- 2. Mark as deleted in database
UPDATE ad_image
SET is_deleted = true
WHERE job_id = ? AND format != ?;
```

---

## Error Handling

### Common Scenarios

1. **Insufficient Tokens**:
   - Error returned before job creation
   - No tokens deducted
   - User must top up tokens

2. **Generation Failure**:
   - n8n workflow fails
   - Tokens automatically refunded
   - User notified of error
   - Job status: `FAILED`

3. **No Brand Selected**:
   - Error returned
   - User must create/select brand first

4. **Network Errors**:
   - Generation continues in background
   - User can refresh page to check status
   - Job polled until completion

---

## Maintenance Best Practices

### For Paid Users

- System automatically maintains 20 ads minimum
- Maintenance runs on dashboard visit
- Generates only when counts fall below threshold
- Background generation doesn't block user workflow

### For All Users

- Quick ads are a one-time generation (on-demand)
- Reuse existing ads when available to save tokens
- Select format carefully (unused format will be deleted)
- Ensure sufficient tokens before generating

---

## Related Documentation

- [Ad Generation Flow](./ad_generation_flow.md) - General ad generation process
- [Token System](./TOKEN_SYSTEM.md) - Token management and costs
- [Database Schema](./database_schema.md) - Schema reference for quick ads tables

---

## Summary

Quick Ads Generation provides:

✅ **Instant Access**: Pre-generated ads for immediate display  
✅ **Cost Efficient**: One token cost for 10 ads (5 per format)  
✅ **Format Flexible**: Generate both formats, use one, discard other  
✅ **Automatic Maintenance**: Paid users get background generation  
✅ **Smart Cleanup**: Unused formats automatically removed  

**Key Points**:
- 50 tokens per generation (10 ads total)
- Tokens taken upfront, not on display
- All users can use, paid users get maintenance
- Unused format ads are deleted when format is selected

